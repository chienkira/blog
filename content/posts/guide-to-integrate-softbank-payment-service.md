---
title: "Softbank決済代行サービス導入についてのまとめ、実装メモ"
date: 2019-12-08T09:36:35+09:00
draft: true
tags: [rails, ruby, payment, programing, Softbank]
language: ja
toc: true
authors: [chienkira]
cover: 
---

**この間、決済代行サービス[（SoftBankペイメント）](https://www.sbpayment.jp/)を案件に導入したので、実際に実装して分かったことをこの記事にまとめてシェアしたいと思います。**

## バックグラウンド
---
- 私はこれまで決済代行サービスとの連携を実装したことがありません。
- この案件は、クレジットカード支払いに対応しなければなりません。今後キャリア支払いも対応する可能性があります。
- Railsで実装されたウェブアプリケーションとの連携となります。

## 決済代行サービスとは
---

- 加盟店と各決済会社（カード会社やオンライ決済）の間に入り、多種の決済方法を対応してくれるサービスです。
- 決済代行サービスを使わない場合、どうなるか？
    - 各決済会社と個別契約をしないといけない　→　審査が大変厳しくなってしまう、工数もかなり掛かってしまう
    - 決済会社によって、入金サイクルや手数料率が異なるので、事務処理に大変手間が掛かってしまう
    - カード情報保管など、加盟店側が行わなければならない為、セキュリティー面の対応のハドルは高い
- ↑のような不便を解決するために、決済代行サービスが存在しています。

![](/blog/images/SB payment-payment gateway.png)

## SoftBankペイメントについてのまとめ
---

### 1. 導入の大きな流れ

* まずは、エントリーシートを記入してSBペイメントへ提出する
* SB側が各決済会社への審査を行ってくれる
* 審査が通過したら、私たち（加盟店）の環境が構築される  
※ キャリア決済の審査が遅い傾向にある為、各カード会社の審査がOKになったら、途中で環境構築が始められるそうです。急いでる方はSBの営業担当者へ依頼してください。
* 環境構築が終わり次第、試験と本番環境の接続情報がもらえる
    * 連携時に必要な情報
    * 管理画面のログイン情報
* 審査に時間はかかる為、基本的には「共用試験環境」を使って実装を先に進めてください！と営業担当者から案内される  
※ 共用試験環境は、SBペイメントの導入を検討している人々がシェアして使える環境である。実装を確認する為に、使えるテストカード情報なども共有される。

### 2. システム接続方式

SBペイメントは以下の2つの接続方法を対応しています。  
契約する時、どちらかしか選択できないという訳ではありません。API＋リンク両方使用することも可能です。

* リンク型：エンドユーザーをSBペイメントの画面に誘導して、決済させるというイメージ
* API型：加盟店の画面がSBペイメントのAPIを呼び出して決済処理を行うというイメージ

##### 2.1 リンク型

SBペイメントが提供する決済手続きの各画面を利用する方式です。
決済処理が終わた後、任意の加盟店側のページに画面遷移されます。

![SB payment リンク型](/blog/images/SB payment-Link.png)

##### 2.2 API型

SBペイメントの画面を使わず、APIでサーバー間の連携を行う方式です。
決済画面全部が自由にカスタマイズできます。

![SB payment API型](/blog/images/SB payment-API.png)

##### 2.3 リンク型とAPI型の比較
|          項目          |                                         リンク型                                        |              API型              |
|:----------------------:|:---------------------------------------------------------------------------------------:|:-------------------------------:|
| 決済画面のカスタマイズ | プラス料金を出せば、デザインのカスタマイズはできるが、 リンク追加など出来ない内容もある |           **自由に**          |
| 決済処理フロー        |             決済代行サービスの仕様に依存           |              **自由に**             |
| 開発容易度と工数      |            **低**                              |                高               |
| 利用可能な決済手段の差 |           **豊富**                             | 一部の決済手段はAPI型対応しない |

### 3. 実装についてのまとめ

##### 3.1 開発者支援サイト

一応あります。こちら[developer.sbpayment.jp](https://developer.sbpayment.jp/)になります。

しかし残念ですが、仕様書のダウンロード以外は、あまり役に立たないという個人の印象でした。  
また、アカウントが必要なのですが、契約しなくても簡単に登録できますので、興味ある方はどうぞ見てみてください。

##### 3.2 リンク型・API型の実装の共通点

加盟店 ⇄ SBペイメント間のリクエストが改ざんされないかバリデーションをする為？だと思いますが、
チェックサムを生成して送ることが必須で要されています。

チェックサムに値が設定されなかった又は正しく生成されなかった場合、リクエストが処理されず、エラーが返ってきます。
このチェックサム生成は実装の最初の壁となり、クリアしないと先に進むことができませんのでかなり重要なところと思います。

チェックサムの生成方法は下記の通りに説明されています。

> リクエストの各パラメーターの値を項目定義順に文字列結合し、
> 最後に当社より払い出されたハッシュキーを結合した値を「UTF-8」へ変換して、
>「SHA1」にてハッシュ演算を行ってください。

2ステップに分けて実装すれば良いかと思います。

* ステップ1：文字列結合
* ステップ2：ハッシュ演算

分かりやすい図を作ってみました。

![SB payment リンク型](/blog/images/SB payment-checksum.png)

github上の他の方のコードを参考にして、以下のように実際コーティングしました。
Railsで標準のモジュールを使ってかなり短く書けますね！

```ruby
def generate_sps_hashcode(encoding: 'UTF-8', hashkey: Sbpayment.config.hashkey)
    Digest::SHA1.hexdigest((values_for_sps_hashcode.map(&:to_s).map(&:strip).join + hashkey).encode(encoding))
end

def values_for_sps_hashcode
    # 各パラメーターの値を項目定義順に返す
end
```

##### 3.3 リンク型の実装

todo

##### 3.4 API型の実装

todo

## 感想
---

SBペイメントは開発者に優しくないという印象でした。

理由はいくつかあります。

- APIはレガシーのxmlしか対応しない
- ドキュメントは日本語のみ、PDF形式のみ
- APIリクエストの認証はアクセスキーのようなものではなく、Basic認証
- リクエスト（APIとリンク両方とも）のバリデーションにハッシュ計算を要される

それに対して、海外のStripe決済代行サービルに比べてみると

- APIはjson対応 :star:
- ドキュメントは多言語対応、web上見れる（検索やナビは簡単）、各プログラミング言語のサンプルコードもある :star:
- リクエストのバリデーションが省略され、安易にAPIが叩ける :star:
- さらに、各言語の公式のモジュールも準備されるので、実装がすごく楽になる :star:

ただ、どこの決済代行サービスを使うか決める時、実装の優しさだけ見てはいけません。
対応できる支払い方法は代行サービスによって異なりますし、コスト面も考えてフィットするプランがあるかどうか検討しなければなりませんね。
